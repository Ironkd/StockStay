generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                         String    @id @default(uuid())
  email                      String    @unique
  name                       String
  firstName                  String?
  lastName                   String?
  password                   String
  address                    String?   @default("")
  streetAddress              String?
  city                       String?
  province                   String?
  postalCode                 String?
  phone                      String?   @default("")
  emailVerified              Boolean   @default(false)
  emailVerificationToken     String?
  emailVerificationExpiresAt DateTime?
  teamId                     String?
  teamRole                   String?   @default("member") // "owner" or "member"
  maxInventoryItems          Int?
  allowedPages               String?   // JSON array of allowed page keys
  allowedPropertyIds         String?   // JSON array of allowed property IDs
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt

  team                Team?                 @relation(fields: [teamId], references: [id], onDelete: SetNull)
  passwordResetTokens PasswordResetToken[]

  @@index([teamId])
  @@index([email])
  @@index([emailVerificationToken])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Team {
  id            String   @id @default(uuid())
  name          String
  ownerId       String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Billing / plan info
  plan          String   @default("free") // "free", "starter", "pro"
  maxProperties Int?     // null = unlimited, or explicit cap
  
  // Trial fields
  isOnTrial     Boolean  @default(false)
  trialEndsAt   DateTime?
  trialPlan     String?  // The plan they're trialing (e.g., "pro")

  // Stripe billing
  stripeCustomerId    String?  // Stripe Customer ID for billing
  stripeSubscriptionId String? // Active subscription ID (when set, plan is paid)
  stripeSubscriptionStatus String? // active, canceled, past_due, etc.
  billingInterval    String?  // "month" | "year" from Stripe subscription

  // Invoice email branding (emailed invoices use this style + logo)
  invoiceLogoUrl     String?  // URL to team logo image
  invoiceStyle       String?  // JSON: { companyName?, primaryColor?, accentColor?, footerText? }

  members User[]
  properties   Property[]
  clients     Client[]
  invoices    Invoice[]
  sales       Sale[]

  @@index([ownerId])
  @@index([isOnTrial])
  @@index([trialEndsAt])
  @@index([stripeCustomerId])
}

model Property {
  id        String   @id @default(uuid())
  teamId    String
  name      String
  location  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team      Team     @relation(fields: [teamId], references: [id])
  items     Inventory[]

  @@index([teamId])
}

model Inventory {
  id               String   @id @default(uuid())
  name             String
  sku              String   @default("")
  category         String   @default("")
  location         String   @default("")
  propertyId       String?
  quantity         Float    @default(0)
  unit             String   @default("")
  reorderPoint     Float    @default(0)
  reorderQuantity  Float    @default(0)
  priceBoughtFor   Float?
  markupPercentage Float?
  finalPrice       Float?
  tags             String   @default("[]") // JSON array
  notes            String   @default("")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  property         Property? @relation(fields: [propertyId], references: [id])

  @@index([propertyId])
  @@index([category])
}

model InventoryMovement {
  id               String   @id @default(uuid())
  teamId           String?
  inventoryItemId  String
  quantityDelta    Float    // positive = in, negative = out
  movementType     String   // adjustment, invoice, sale, transfer_in, transfer_out
  referenceType    String?  // invoice, sale, transfer
  referenceId      String?
  referenceLabel   String?
  createdAt        DateTime @default(now())

  @@index([teamId])
  @@index([inventoryItemId])
  @@index([createdAt])
}

model Client {
  id          String   @id @default(uuid())
  teamId      String?
  name        String
  email       String   @default("")
  phone       String   @default("")
  address     String   @default("") // Legacy field
  streetAddress String? @default("")
  city        String?  @default("")
  province    String?  @default("")
  postalCode  String?  @default("")
  country     String?  @default("")
  company     String   @default("")
  notes       String   @default("")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  team        Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  @@index([email])
  @@index([teamId])
}

model Invoice {
  id            String   @id @default(uuid())
  teamId        String?
  invoiceNumber String
  clientId      String?
  clientName    String   @default("")
  date          String   // ISO date string
  dueDate       String?  // ISO date string
  items         String   // JSON array of invoice items
  subtotal      Float    @default(0)
  tax           Float    @default(0)
  total         Float    @default(0)
  status        String   @default("draft") // draft, sent, paid, overdue
  notes         String   @default("")
  saleId        String?  @unique // when set, this invoice was created from a sale
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  team          Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  @@index([clientId])
  @@index([invoiceNumber])
  @@index([saleId])
  @@index([teamId])
}

model Sale {
  id        String   @id @default(uuid())
  teamId    String?
  saleNumber String  @default("")
  clientId  String?
  clientName String @default("")
  date      String   // ISO date string
  items     String   // JSON array of sale items
  subtotal  Float    @default(0)
  tax       Float    @default(0)
  total     Float    @default(0)
  notes     String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team      Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  @@index([clientId])
  @@index([date])
  @@index([teamId])
}

model Invitation {
  id                String    @id @default(uuid())
  teamId            String
  email             String
  teamRole          String    @default("member")
  maxInventoryItems Int?
  allowedPages      String?   // JSON array
  allowedPropertyIds  String? // JSON array
  status            String    @default("pending") // pending, accepted, expired
  token             String    @unique
  createdAt         DateTime  @default(now())
  expiresAt         DateTime?
  invitedByUserId   String?
  acceptedAt        DateTime?
  acceptedByUserId  String?

  @@index([teamId])
  @@index([token])
  @@index([email])
}
